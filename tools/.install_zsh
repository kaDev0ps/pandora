#!/bin/bash -xve
set -xve

# Check if the script is run as root, exit if true
if [ "$EUID" -eq 0 ]; then
  echo "This script should be run as a regular user, not root."
  exit 1
fi

# Update package list and install git and zsh
sudo apt-get update && sudo apt-get install git zsh -y

# Try to install powerline and fonts-powerline, continue even if it fails
if ! sudo apt-get install powerline fonts-powerline -y; then
  echo "Installation of powerline and fonts-powerline failed. Continuing without them."
fi

# Install grc (Generic Colourizer) for colored command output
sudo apt-get install grc -y

# Function to add line to file if not already present
add_line_if_not_exists() {
  local file="$1"
  local line="$2"
  grep -qxF "$line" "$file" 2>/dev/null || echo "$line" >> "$file"
}

# Remove existing Oh My Zsh directory if it exists
if [ -d "$HOME/.oh-my-zsh" ]; then
  rm -rf "$HOME/.oh-my-zsh"
fi

# Clone the Oh My Zsh repository into user's home directory
git clone https://github.com/robbyrussell/oh-my-zsh.git "$HOME/.oh-my-zsh"

# Copy the Oh My Zsh template zsh configuration file
cp "$HOME/.oh-my-zsh/templates/zshrc.zsh-template" "$HOME/.zshrc"

# Change the default ZSH theme in the config file
sed -i 's/^ZSH_THEME=".*"/ZSH_THEME="jonathan"/' "$HOME/.zshrc"

# Disable oh-my-zsh auto update if not already set
if ! grep -q '^DISABLE_AUTO_UPDATE="true"' "$HOME/.zshrc"; then
  sed -i '/^ZSH_THEME=/a DISABLE_AUTO_UPDATE="true"' "$HOME/.zshrc"
fi

# Remove existing zsh-syntax-highlighting directory if it exists
if [ -d "$HOME/.zsh-syntax-highlighting" ]; then
  rm -rf "$HOME/.zsh-syntax-highlighting"
fi

# Clone the syntax highlighting plugin with shallow depth
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$HOME/.zsh-syntax-highlighting" --depth 1

# Add source command for syntax highlighting plugin to .zshrc if absent
add_line_if_not_exists "$HOME/.zshrc" "source \$HOME/.zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"

# Remove existing zsh-autosuggestions directory if it exists
if [ -d "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions" ]; then
  rm -rf "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
fi

# Clone the autosuggestions plugin into the custom plugins directory
git clone https://github.com/zsh-users/zsh-autosuggestions "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions"

# Add the autosuggestions plugin to the plugins list in the config if missing
if grep -q '^plugins=(git)' "$HOME/.zshrc"; then
  sed -i 's/^plugins=(git)$/plugins=(git zsh-autosuggestions)/' "$HOME/.zshrc"
elif ! grep -q 'zsh-autosuggestions' "$HOME/.zshrc"; then
  sed -i '/^plugins=/ s/)/ zsh-autosuggestions)/' "$HOME/.zshrc"
fi

# Set style for autosuggestions if not already set
add_line_if_not_exists "$HOME/.zshrc" "ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=blue,bold'"

# Add extended history options and alias for history command if missing
if ! grep -q 'setopt extended_history' "$HOME/.zshrc"; then
  cat >> "$HOME/.zshrc" <<'EOF'
setopt extended_history
HIST_STAMPS="yyyy-mm-dd hh:mm:ss"
alias history="fc -l -i"
EOF
fi

# Change default shell to zsh for the current user
sudo chsh -s /bin/zsh "$USER"

# Download bash aliases file
wget -q https://raw.githubusercontent.com/kaDev0ps/pandora/main/tools/.bash_alias -O "$HOME/.bash_aliases"

# Add source for .bash_aliases in .bashrc if missing
add_line_if_not_exists "$HOME/.bashrc" 'if [ -f ~/.bash_aliases ]; then . ~/.bash_aliases; fi'

# Add source for .bash_aliases in .zshrc if missing
add_line_if_not_exists "$HOME/.zshrc" 'if [ -f ~/.bash_aliases ]; then source ~/.bash_aliases; fi'

# Add environment and source lines for grc to .bashrc and .zshrc if missing
add_line_if_not_exists "$HOME/.bashrc" 'export GRC_ALIASES=true'
add_line_if_not_exists "$HOME/.bashrc" '[[ -s "/etc/profile.d/grc.sh" ]] && source /etc/profile.d/grc.sh'

add_line_if_not_exists "$HOME/.zshrc" '[[ -s "/etc/grc.zsh" ]] && source /etc/grc.zsh'

# Reload the zsh configuration to apply changes
source "$HOME/.zshrc"

echo "Installation completed successfully."
